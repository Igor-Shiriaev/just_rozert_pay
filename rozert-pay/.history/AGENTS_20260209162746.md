# Руководство для AI-агентов

Этот документ содержит инструкции для AI-агентов при работе с кодом проекта.

## Локальные правила

Всегда следуй AGENTS.local.md если он есть в системе.
Если там прописан python env для запуска тестов используй его

## Тестирование

Для любых HTTP-моков в тестах всегда подключай `requests_mock`.

**Важно:** Старайся использовать моки по минимуму:
1. Моки делают тесты хрупкими — при изменении реализации придётся править много тестов
2. Могут появиться ошибки интеграции — например, проверил, что мок функции вызывается с одними параметрами, а в другом месте вызвал с другими — ошибка

Если мокать всё равно нужно, то лучше выносить их в фикстуру / context manager.

## Работа с кодом

Не правь код без разрешения.
Всегда сначала предложи план и опиши что хочешь сделать и спроси одобрения у разработчика

Импорты: используй относительные импорты только внутри текущего модуля (одна точка в начале). Для соседних/верхних модулей используй абсолютные импорты.

## Property методы в моделях

**Важно:** Property методы в моделях Django не должны делать запросов в базу данных.

1. Если логика нужна только для сериализатора — выноси её в сериализатор через `SerializerMethodField`
2. Если property всё же должен обращаться к БД (что крайне нежелательно), используй `@cached_property` из `functools`
3. Property, которые обращаются к связанным объектам через ForeignKey/ManyToMany, могут вызывать N+1 запросы, если забыть добавить `select_related`/`prefetch_related` в queryset. Это легко пропустить, если property используется в сериализаторе

**Правило:** Если property нужен только для API/сериализатора — реализуй логику в сериализаторе, а не в модели

## Интеграция платежки

!!! ВАЖНО !!!

ПЕРВЫМ ШАГОМ ВСЕГДА ГЕНЕРИ ДИЗАЙН ДОК И СПРАШИВАЙ АППРУВА У РАЗРАБОТЧИКА!
НЕ ТРОГАЙ КОД ПОКА ДИЗАЙН НЕ УТВЕРЖДЕН!!!!

НЕ ХРАНИ СЕКРЕТЫ В КОДЕ!

* В самом начале не трогай код, а создавай design доку в docs/integrations/ и итеративно дорабатывай ее с разработчиком.
  В доке должна быть:
  * Информация по deposit/withdraw flow
  * Нужный контекст для агентов чтобы можно было продолжить в новом чате
  * В доке должна быть вся основная информация, кратко. Не вставляй туда код

* Смотри существующие интеграции и придерживайся такого же кодстайла
* Обязательно пиши happy path тесты для депозита и вывода. Мокать в них можно только внешние
  http запросы с помощью requests_mock
* Также нужно добавлять интеграцию в back проект. Он лежит уровнем выше чем текущий, вот тут: `<github root>/back`
  * Добавляй интеграцию rozert_... в бэк
  * Смотри примеры существующих интеграций и придерживайся кодстайла
  * Пиши happy path тесты по аналогии с существующими

* При доработках по платежке обновляй файл с контекстом
