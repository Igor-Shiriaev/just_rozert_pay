# M-Pesa MZ Integration Design Document

## Общая информация

**Название интеграции:** `mpesa_mz`
**Платежная система:** M-Pesa (Mozambique)
**Документация:** https://developer.mpesa.vm.co.mz/documentation/#introduction
**SDK:** https://github.com/paymentsds/mpesa-python-sdk

## Доступ и креденшалы

**Service Provider Code:** `171717`

**URL для коллбэков:** Настраивается в портале разработчика

### Авторизация

Интеграция строится через SDK `paymentsds-mpesa` (mpesa-python-sdk), который сам
формирует `Authorization: Bearer <encoded_api_key>` и шифрует `api_key` публичным ключом.

Также в нашем коде есть вспомогательная реализация сборки bearer-токена
через RSA PKCS#1 v1.5 (используется в тестах).

**Важно:** public key — RSA 4096-bit в Base64, `api_key` — строка длиной 32 символа.
Секреты храним только в креденшалах, в код не добавляем.

## Deposit Flow

### Документация
- API: https://developer.mpesa.vm.co.mz/apis/3/1/

### Параметры запроса депозита (по коду)

- `transaction` - ID транзакции для M-Pesa
  - Формат: первая часть UUID транзакции до первого дефиса
  - Пример: `550e8400` из `550e8400-e29b-41d4-a716-446655440000`

- `reference` - ThirdPartyReference
  - Формат: совпадает с `transaction` (первая часть UUID)

- `from` - номер телефона клиента (MSISDN)
  - **Текущее поведение:** значение захардкожено в коде (`258844680146`)
  - Требуется заменить на `user_data.phone`

- `amount` - сумма депозита
  - **Текущее поведение:** значение захардкожено в коде (`10`)
  - Требуется заменить на сумму из запроса на создание транзакции

### Flow депозита

1. Мерчант создает транзакцию через API, передавая:
   - `user_data.phone` - номер телефона пользователя
   - `amount` - сумма депозита
   - `currency` - валюта (MZN)

2. Наша система:
   - Создает транзакцию со статусом `PENDING`
   - Формирует `transaction` и `reference` из первой части UUID транзакции
   - Создает или обновляет `CustomerExternalPaymentSystemAccount` с номером телефона в `MpesaController`
   - Вызывает SDK `paymentsds-mpesa` (операция C2B / receive)
   - Сохраняет `id_in_payment_system` из ответа SDK (поле `data.transaction` или `data.reference`)

3. M-Pesa:
   - Отправляет уведомление пользователю на телефон
   - Пользователь подтверждает платеж в приложении M-Pesa

4. После успешного депозита:
   - M-Pesa отправляет коллбэк в нашу систему
   - Мы запрашиваем статус через API M-Pesa и обновляем статус транзакции
   - **Важно:** привязка кошелька к номеру телефона уже создана при создании транзакции

5. Отправляем коллбэк мерчанту с результатом

### Хранение номера телефона

При создании транзакции (в `MpesaController`) необходимо сохранить номер телефона для использования при выводе:
- Использовать модель `CustomerExternalPaymentSystemAccount`
- `system_type` = `mpesa_mz`
- `unique_account_number` = номер телефона пользователя
- `wallet` = кошелек транзакции
- `customer` = клиент из транзакции

## Transaction Status Check

### Документация

### Описание
M-Pesa предоставляет API для проверки статуса транзакции. Это используется для периодических проверок статуса транзакций, которые находятся в статусе `PENDING`.

### Использование
- Реализуется в методе `_get_transaction_status()` клиента (SDK `query`)
- Запрос формируется с `subject` и `reference` = первая часть UUID транзакции
- Вызывается при обработке коллбэка и при периодических проверках статуса
- Используется для синхронизации статуса транзакции, если коллбэк не был получен или был пропущен

### Параметры запроса
- Обычно требуется:
  - Идентификатор транзакции в системе M-Pesa (`id_in_payment_system`)
  - Или `ThirdPartyReference` (UUID транзакции)

### Обработка ответа
- Парсим ответ от M-Pesa API
- Определяем статус транзакции (Success/Failed/Pending)
- Обновляем статус транзакции в нашей системе через `sync_remote_status_with_transaction`

## Withdraw Flow

### Документация
- API: https://developer.mpesa.vm.co.mz/apis/5/6/

### Параметры запроса вывода (по коду)

- `transaction` - ID транзакции для M-Pesa
  - Формат: полный UUID транзакции
  - Пример: `550e8400-e29b-41d4-a716-446655440000`

- `reference` - ThirdPartyReference
  - Формат: полный UUID транзакции

- `to` - номер телефона
  - Берется из `CustomerExternalPaymentSystemAccount`, созданного при создании депозита
  - Если кошелек не привязан к номеру телефона, вывод отклоняется с `NO_PHONE_NUMBER`

- `amount` - сумма вывода
  - Берется из запроса на создание транзакции

### Flow вывода

1. Мерчант создает транзакцию вывода через API

2. Наша система:
   - Проверяет наличие привязанного номера телефона в `CustomerExternalPaymentSystemAccount`
   - Если номер не найден, отклоняем транзакцию с `decline_code=NO_PHONE_NUMBER`
   - Создает транзакцию со статусом `PENDING`
   - Формирует `transaction` и `reference` из полного UUID транзакции
   - Вызывает SDK `paymentsds-mpesa` (операция B2C / send)
   - Сохраняет `id_in_payment_system` из ответа SDK (поле `data.transaction` или `data.reference`)

3. M-Pesa:
   - Обрабатывает запрос на вывод
   - Отправляет средства на указанный номер телефона

4. M-Pesa отправляет коллбэк в нашу систему с результатом:
   - При успехе: обновляем статус на `SUCCESS`
   - При ошибке: обновляем статус на `FAILED` с кодом и причиной отклонения

5. Отправляем коллбэк мерчанту с результатом

## Callback обработка

### Формат коллбэка (по коду)
- Ожидается JSON с полями:
  - `output_TransactionID` (id_in_payment_system)
  - `output_ThirdPartyReference` (UUID транзакции)
- Статус из коллбэка не используется напрямую

### Валидация коллбэка
- Проверка подписи не реализована (возвращается `True`)
- Опора на IP whitelist и `callback_secret_key` (общий механизм)
- Валидация тела коллбэка: попытка распарсить JSON и найти транзакцию

## Структура интеграции

### Файлы (фактически в коде)

1. `rozert_pay/payment/systems/mpesa_mz/`
   - `client.py` - SDK-обертка, запросы C2B/B2C и query
   - `controller.py` - логика транзакций, коллбэк и привязка телефона
   - `views.py` - endpoints `/api/payment/v1/mpesa-mz/deposit|withdraw/`
   - `entities.py` - модель креденшалов
   - `const.py` - зарезервировано под константы (сейчас пустой)

2. Роуты:
   - `rozert_pay/payment/api_v1/urls.py` — `mpesa-mz`
   - коллбэк: `/api/payment/v1/callback/mpesa-mz/`

3. Тесты:
   - `tests/payment/systems/mpesa_mz/test_mpesa_mz.py`

### Модели данных

**Credentials (entities.py):**
- `api_key` - API ключ
- `public_key` - публичный ключ для RSA шифрования `api_key`
- `service_provider_code` - код мерчанта (171717)
- `base_url` - базовый URL API M-Pesa (передается в SDK как `environment`)

### Особенности реализации

1. **Зависимость SDK:**
   - Используем `paymentsds-mpesa` для C2B/B2C операций
   - Клиент инициализируем из креденшалов (`api_key`, `public_key`, `service_provider_code`)

2. **Формирование TransactionReference:**
   - Депозит: `transaction/reference` = первая часть UUID
   - Вывод: `transaction/reference` = полный UUID

3. **Привязка кошелька к номеру телефона:**
   - При создании транзакции в `MpesaController` создаем/обновляем `CustomerExternalPaymentSystemAccount`
   - Используем номер телефона из `user_data.phone`

4. **Проверка при выводе:**
   - Перед созданием транзакции вывода проверяем наличие `CustomerExternalPaymentSystemAccount`
   - Если не найден, возвращаем ошибку

5. **Обработка коллбэков:**
   - Парсим JSON коллбэка
   - Находим транзакцию по `output_TransactionID` или `output_ThirdPartyReference`
   - Запрашиваем статус через SDK `query` и синхронизируем статус

6. **Проверка статуса транзакции:**
   - Реализована через SDK `query`
   - Используется как при коллбэке, так и для периодических проверок
   - `subject/reference` берутся как первая часть UUID

## Тестирование

### Тесты (по факту)

1. **Депозит:**
   - Успешный сценарий с коллбэком и привязкой телефона
   - Мгновенный фейл при коде ответа SDK != `INS-0`

2. **Вывод:**
   - Успех при наличии привязанного телефона
   - Ошибка `NO_PHONE_NUMBER` при отсутствии привязки
   - Мгновенный фейл при коде ответа SDK != `INS-0`

### Мокирование

- Для депозитов/выводов мокируем SDK `paymentsds-mpesa`, а не HTTP
- Не мокировать внутренние вызовы системы

## Интеграция в back проект

- Добавить интеграцию `rozert_mpesa_mz` в back проект (уровнем выше)
- Следовать кодстайлу существующих интеграций
- Написать happy path тесты по аналогии с существующими
