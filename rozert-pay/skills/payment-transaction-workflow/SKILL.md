---
name: payment-transaction-workflow
description: Использовать для задач, где меняются жизненный цикл PaymentTransaction, переходы статусов, callback-обработка, периодические проверки или балансовые side-effects в rozert-pay.
---

# Порядок Работы С PaymentTransaction

Используй этот навык, когда задача меняет поведение платежных статусов, обработку callback или флоу процессинга транзакции.

## Порядок работы

1. Прочитать архитектурную справку: `docs/agents/payment-transaction-architecture.md`.
2. Найти текущий кодовый путь создания/процессинга/синхронизации.
3. Подтвердить, что переходы статусов выполняются только через synchronization/controller flow.
4. Проверить балансовые side-effects для обновленного статусного пути.
5. Проверить безопасность конкурентного доступа (`transaction.atomic()`, `select_for_update()` где нужно).
6. Убедиться, что аудит-логирование (`event_logs`/`PaymentTransactionEventLog`) сохранено.
7. Добавить или обновить тесты для happy path и failure path.
8. Запустить проверки:
   - таргетные тесты;
   - `make mypy`;
   - полный набор (`make mypy`, `make lint`, `make pylint`, `make pytest`) для критичных изменений статусной логики.

## Жесткие ограничения

- Не обновлять `PaymentTransaction.status` напрямую в произвольном бизнес-коде.
- Не выполнять внешние HTTP-вызовы внутри открытой DB-транзакции.
- В Celery-задачи передавать идентификаторы, а не ORM-объекты.
